{% extends 'nadc/base.html' %}
{% load staticfiles %}
{% load additionalinfo %}
{% load humanize %}

{% block title %}{% if name.standard_name %}{{ name.standard_name|title }}{% else %}{{ name.cand_name|title }}{% endif %} - {% endblock %}

    {% block social %}
    <meta name="description" content="Campaign finance data including donations, expenditures, targeted political spending and loans for {% if name.standard_name %}{{ name.standard_name|title }}{% else %}{{ name.cand_name|title }}{% endif %}">

	<meta property="og:title" content="{% if name.standard_name %}{{ name.standard_name|title }}{% else %}{{ name.cand_name|title }}{% endif %} - Nebraska Campaign Finance">
	<meta property="og:image" content="XXXXXXXXXX">
	<meta property="og:site_name" content="Dataomaha.com">
	<meta property="og:description" content="Campaign finance summary including donations, expenditures, targeted political spending and loans for {% if name.standard_name %}{{ name.standard_name|title }}{% else %}{{ name.cand_name|title }}{% endif %}">
	<meta property="fb:app_id" content="117714391577072">
	
	<meta name="twitter:card" content="summary">
	<meta name="twitter:site" content="@OWHnews">
	<meta name="twitter:creator" content="@dataomaha">
	<meta name="twitter:title" content="{% if name.standard_name %}{{ name.standard_name|title }}{% else %}{{ name.cand_name|title }}{% endif %} -  Nebraska Campaign Finance">
	<meta name="twitter:description" content="Campaign finance summary including donations, expenditures, targeted political spending and loans for {% if name.standard_name %}{{ name.standard_name|title }}{% else %}{{ name.cand_name|title }}{% endif %}">
	<meta name="twitter:image:src" content="XXXXXXXXXX">
    {% endblock %}

{% block morestyles %}
    <link href="{% static "nadc/entity.css" %}" rel="stylesheet">
    <link href="http://dataomaha.com/media/scripts/bootstrap-datepicker/bootstrap-datepicker.css" rel="stylesheet">
{% endblock %}

{% block content %}

{% include 'nadc/nav.html' %}

	<div id="upper">	
	<div class="container">

		<div class="row">
		<div class="col-sm-12">
			<h1><b>{% if name.standard_name %}{{ name.standard_name|title }}{% else %}{{ name.cand_name|title }}{% endif %}</b></h1>
            
            {% if not gets and not loans and not gives and not normal_expenditures and not ind_expenditures %}
            
            <p>This entity is registered with the NADC but doesn't have any reportable campaign activity.</p>
        </div>
		</div>
    </div>
    </div>
            {% else %}
    
		</div>
		</div>
		
		<div class="row">
		<div class="col-sm-12">
		
			<p class="text-muted">
			{% if name.city and name.state %}{{ name.city|title }}, {{ name.state }}{% endif %}  
			{% if name.dissolved_date %} &bull; Committee dissolved in {{ name.dissolved_date|date:"o" }}{% endif %} 
			<!--{% if name.employer or name.occupation or name.place_of_business %} &bull; {% if name.occupation %}{{ name.occupation|title }}{% endif %}{% if name.employer %} at {{ name.employer|title }}{% endif %}{% if name.place_of_business %}, {{ name.place_of_business|title }}{% endif %}{% endif %}-->
			</p>
            
            
			
		</div>
		</div>
		<h3><a id="tw"><i class="fa fa-twitter sharetop"></i></a>&ensp;<a id="fb"><i class="fa fa-facebook-square sharetop"></i></a></h3>{% if name.notes %}
        
        <p class="small muted">{{ name.notes }}</p>{% endif %}
        
		<hr />
		
		<div class="row amounts">


			<div class="col-sm-8">
			

				{% if gives %}
				<div class="col-sm-6" id="givestotal"></div>
				{% endif %}
					
				{% if gets %}
				<div class="col-sm-6" id="getstotal"></div>
				{% endif %}
	
				
				{% if normal_expenditures %}
				<div class="col-sm-6" id="campaign_spending_total"></div>
				{% endif %}
				
				{% if ind_expenditures %}
				<div class="col-sm-6" id="targeted_spending_total"></div>
				{% endif %}
				
				{% if loans %}
				<div class="col-sm-6" id="loantotal"></div>
				{% endif %}	
	
			</div>
			
			
			{% if gives or comm_candidates %}
			<div class="col-sm-4">
		
					<p>{% if gives %}&raquo; Gave {{ gives.count|apnumber|intcomma }} donation{{ gives.count|pluralize }}{% endif %}{% if not gets %} between {{ first }} and {{ mostrecent }}.{% else %} {% if gives and gets %}and{% endif %} {% if gets and not gives %}&raquo; R{% else %}r{% endif %}eceived {{ gets.count|apnumber|intcomma }} contribution{{ gets.count|pluralize }} between {{ first }} and {{ mostrecent }}. {% endif %}</p>
			
			{% if comm_candidates %}<p>&raquo; Backing: {% for candidate in comm_candidates %}{% if candidate.stance = "0" %}{{ candidate.cand_name|title }}<!-- for {{ candidate.office_desc|title }} {{ candidate.office_title|title }}-->{% if not forloop.last %}{% if comm_candidates.count > 2 %}{% if not forloop.last %}, {% else %} and {% endif %} {% else %} and {% endif %}{% endif %}{% endif %}{% endfor %}</p>{% endif %}

			{% endif %}
			
			{% if gets %}<p>&raquo; <a href="http://www.nadc.nebraska.gov/ccdb/search.cgi?page=details&type=committee&IDNO={{ name.nadcid }}" target="_blank">Official NADC records</a></p>{% endif %}
			
			<p><small>{% for name in name.misc_peeps.all %}<li>{{ name }}</li>{% endfor %}</small></p>


			</div>
		
		</div>
		
		
		<div class="row">
		<div class="col-sm-12">	
				
		</div>
		</div>
		
			{% comment %}
			{% if comm_candidates %}
				<h4>Candidate{{ comm_candidates|pluralize }} supported</h4>
				<ul>
				{% for can in comm_candidates %}
				{% if can.stance == "0" %}
					<li>{{ can.cand_name|title }} ({{ can.office_desc|title }} {{ can.office_title|title }})</li>
				{% endif %}
				{% endfor %}
				</ul>
				{% if comm_candidates.count > 1 %}
				<h4>Candidate{{ comm_candidates|pluralize }} opposed</h4>
				<ul>
				{% for can in comm_candidates %}
				{% if can.stance == "1" %}
					<li>{{ can.cand_name|title }} ({{ can.office_desc|title }} {{ can.office_title|title }})</li>
				{% endif %}
				{% endfor %}
				</ul>
				{% endif %}

			{% endif %}
			{% endcomment %}

			{% if person_candidates %}
				<h4>{% for can in person_candidates %}{% if forloop.first %}{{ can.cand_name|title }}{% endif %}{% endfor %} ran for office {{ person_candidates.count|apnumber }} time{{ person_candidates.count|pluralize }}.</h4>
				{% for can in person_candidates %}
					<li><a href="/campaign-finance/candidate/{{ can.cand_id }}">{{ can.cand_name|title }} ({{ can.office_desc|title }} {{ can.office_title|title }})</a></li>
				{% endfor %}
			{% endif %}
		
        </div>
        
        
        
        
    </div>		<!-- /#upper -->
	{% additionalinfo id %}

<div id="filters">
<div class="container">
    <h1 class="center" id="loading">
        <i class="fa fa-spinner fa-pulse"></i>
    </h1>
    
	<div class="row">
        <div id="button_duder"></div>
		<div class="col-sm-4">
			<div id="datefilter">
				<h4><i class="fa fa-calendar"></i> Filter by date</h4>
				<div class="input-group input-daterange">
						<input type="text" class="form-control" id="startdate">
						<span class="input-group-addon">to</span>
						<input type="text" class="form-control" id="enddate">
						<span class="input-group-btn">
							<button class="btn btn-default" type="button" id="date_filter_button">Filter</button>
						</span>
					</div>
			</div>
		</div>
		
	</div>
		
</div>
</div>

<div id="wrapper">
    <div class="container">
        <h2 class="bold" id="display_hed"></h2>
        <h5 class="filterwarning muted">Records are filtered&ensp;&bull;&ensp;<a class="removefilter">Remove filter</a></h5>
        <div id="display_table"></div>
    </div>
</div>

{% if gives %}
<!-- underscore template for "gives" table" -->
<script type="text/html" class="gives_table_template">
    <table class="table">
        <thead>
            <tr>
                <th>Recipient</th>
				<th class="r">Donations</th>
                <th class="r">Total</th>
                <th class="r">% of donations</th>
            </tr>
        </thead>
        <tbody>
        <% _.each( data_to_template.gives_table_data, function( d ){ %>
            <tr class="totals">
				<td><% if (!d.id || d.id === "") { %><%= d.name %><% } else { %><a href="/campaign-finance/<%= d.id %>/<%= slugify(d.name) %>"><%= d.name %></a><% }; %></td>
				<td class="r"><%= d.gives.length %></td>
				<td class="r">$<%= addCommas(d.sum.toFixed(0).replace(".00","")) %>&ensp;<i class="fa fa-caret-down text-muted click_to_expand" data-toggle="tooltip" title="Click for more details"></i></td>
                
                <td class="r" style='margin:0px; background: -webkit-gradient(linear, left top,right top, color-stop(<%= getPct(d.sum, data_to_template.gives_total_sum) %>%,<%= data_to_template.gives_color %>), color-stop(<%= getPct(d.sum, data_to_template.gives_total_sum) %>%,#eee)); background: -moz-linear-gradient(left center, <%= data_to_template.gives_color %> <%= getPct(d.sum, data_to_template.gives_total_sum) %>%, #eee <%= getPct(d.sum, data_to_template.gives_total_sum) %>%); background: -o-linear-gradient(left,<%= data_to_template.gives_color %> <%= getPct(d.sum, data_to_template.gives_total_sum) %>%, #eee <%= getPct(d.sum, data_to_template.gives_total_sum) %>%); linear-gradient(to right,<%= data_to_template.gives_color %> <%= getPct(d.sum, data_to_template.gives_total_sum) %>%, #eee <%= getPct(d.sum, data_to_template.gives_total_sum) %>%)'>
                
                <%= getPct(d.sum, data_to_template.gives_total_sum).toFixed(0) %>%
                
                </td>
            </tr>
            <!-- here's the loop with the stuff to show/hide -->
                    <% _.each( d.gives, function( ind_don ){ %>
						<tr class="toggle small <%= d.id %>">
							<td><%= d.name %></td>
							<td class="r"><%= ind_don.display_date %></td>
							<td class="r">
                            <% if (ind_don.cash > 0) { %>
                                <a href="/campaign-finance/<%= ind_don.pk %>">$<%= addCommas(ind_don.cash.toFixed(0)) %></a>
                            <% }; %>
                            <% if (ind_don.inkind > 0) { %>
                                <a href="/campaign-finance/<%= ind_don.pk %>">$<%= addCommas(ind_don.inkind.toFixed(0)) %></a>
                            <% }; %>
                            </td>
                            
						</tr>
                    <% }); %>
            <!-- // -->
            
        <% }); %>
        </tbody>
    </table>
</script>
{% endif %}{# end if gives #}

{% if gets %}
<!-- underscore template for "gets" table" -->
<script type="text/html" class="gets_table_template">
    <table class="table">
        <thead>
            <tr>
                <th>Donor</th>
				<th class="r">Donations</th>
                <th class="r">Total</th>
                <th class="r">% of total</th>
            </tr>
        </thead>
        <tbody>
        <% _.each( data_to_template.gets_table_data, function( d ){ %>
            <tr class="totals">
                 <td><a href="/campaign-finance/<%= d.id %>/<%= slugify(d.name) %>"><%= d.name %></a></td>
				 <td class="r"><%= d.gives.length %></td>
                 <td class="r">$<%= addCommas(d.sum.toFixed(0).replace(".00","")) %>&ensp;<i class="fa fa-caret-down text-muted click_to_expand" data-toggle="tooltip" title="Click for more details"></i></td>
                 
                 <td class="r" style='margin:0px; background: -webkit-gradient(linear, left top,right top, color-stop(<%= getPct(d.sum, data_to_template.gets_total_sum) %>%,<%= data_to_template.gets_color %>), color-stop(<%= getPct(d.sum, data_to_template.gets_total_sum) %>%,#eee)); background: -moz-linear-gradient(left center, <%= data_to_template.gets_color %> <%= getPct(d.sum, data_to_template.gets_total_sum) %>%, #eee <%= getPct(d.sum, data_to_template.gets_total_sum) %>%); background: -o-linear-gradient(left,<%= data_to_template.gets_color %> <%= getPct(d.sum, data_to_template.gets_total_sum) %>%, #eee <%= getPct(d.sum, data_to_template.gets_total_sum) %>%); linear-gradient(to right,<%= data_to_template.gets_color %> <%= getPct(d.sum, data_to_template.gets_total_sum) %>%, #eee <%= getPct(d.sum, data_to_template.gets_total_sum) %>%)'>
                
                <%= getPct(d.sum, data_to_template.gets_total_sum).toFixed(0) %>%
                 
                 </td>
            </tr>
            <!-- here's the loop with the stuff to show/hide -->
					<% _.each( d.gives, function( ind_don ){ %>
					<tr class="toggle small <%= d.id %>">
						<td><%= d.name %></td>
						<td class="r"><%= ind_don.display_date %></td>
						<td class="r">
                        <% if (ind_don.cash > 0) { %>
                            $<%= addCommas(ind_don.cash.toFixed(0)) %>
                        <% }; %>
                        <% if (ind_don.inkind > 0) { %>
                            $<%= addCommas(ind_don.inkind.toFixed(0)) %>*
                        <% }; %>
                        </td>
					</tr>
                    <% }); %>
            <!-- // -->
        <% }); %>
        </tbody>
    </table>
</script>

{% endif %}{# end if gets #}

{% if normal_expenditures or ind_expenditures %}
<!-- underscore template for "expenditure" tables -->
<script type="text/html" class="spending_table_template">
    {% if ind_expenditures %}
    <h3>Spending to support or oppose a candidate or committee</h3>
   	<p class="text-muted pull-right small">* in-kind spending</p>

	<table class="table table-condensed">
        <thead>
            <tr>
                <th>Supporting/opposing</th>
				<th class="r">Expenditures</th>
                <th class="r">Total</th>
                <th class="r">% of total</th>            
            </tr>
        </thead>
        <tbody>
    <% _.each( data_to_template.targeted_spending_data, function( d ){ %>
        <tr class="totals">
        <td><a href="/campaign-finance/<%= d.id %>/<%= d.slug %>"><%= d.name %></a></td>
        <td class="r"><%= d.spending.length %></td>
        <td class="r">$<%= addCommas(d.sum.toFixed(0).replace(".00","")) %>&ensp;<i class="fa fa-caret-down text-muted click_to_expand" data-toggle="tooltip" title="Click for more details"></i></td>

        <td class="r" style='margin:0px; background: -webkit-gradient(linear, left top,right top, color-stop(<%= getPct(d.sum, data_to_template.targeted_spending_total) %>%,<%= data_to_template.spending_color %>), color-stop(<%= getPct(d.sum, data_to_template.targeted_spending_total) %>%,#eee)); background: -moz-linear-gradient(left center, <%= data_to_template.spending_color %> <%= getPct(d.sum, data_to_template.targeted_spending_total) %>%, #eee <%= getPct(d.sum, data_to_template.targeted_spending_total) %>%); background: -o-linear-gradient(left,<%= data_to_template.spending_color %> <%= getPct(d.sum, data_to_template.targeted_spending_total) %>%, #eee <%= getPct(d.sum, data_to_template.targeted_spending_total) %>%); linear-gradient(to right,<%= data_to_template.spending_color %> <%= getPct(d.sum, data_to_template.targeted_spending_total) %>%, #eee <%= getPct(d.sum, data_to_template.targeted_spending_total) %>%)'>
                
        <%= getPct(d.sum, data_to_template.targeted_spending_total).toFixed(0) %>%
                 </td>
        </tr>
        
        <!-- here's the loop with the stuff to show/hide -->
        <% _.each( d.spending, function( spend ){ %>
            <tr class="toggle small <%= spend.id %>">
                <td>
                <% if (spend.exp_purpose) { %><%= spend.exp_purpose %><% } else { %><%= d.name %><% }; %><% if (spend.stance) { %> (<%= spend.stance.toLowerCase() %>)<% }; %></td>
                <td class="r"><%= spend.display_date %></td>
                <td class="r">
                    <% if (spend.amount > 0) { %>
                        $<%= addCommas(spend.amount.toFixed(0)) %>
                    <% }; %>
                    <% if (spend.inkind > 0) { %>
                        $<%= addCommas(spend.inkind.toFixed(0)) %>*
                    <% }; %>
                </td>
            </tr>
        <% }); %>
        <!-- // -->
        
    <% }); %>
        </tbody>
        </table>
    
    {% endif %}
    
    {% if normal_expenditures %}
    <h3>{% if ind_expenditures %}Other c{% else %}C{% endif %}ampaign spending</h3>
	<p class="text-muted pull-right small">* in-kind spending</p>

    <table class="table table-condensed">
        <thead>
            <tr>
                <th>Paid to</th>
                <th>For</th>
                <th class="r">Date</th>
                <th class="r">Amount</th>
            </tr>
        </thead>
        <tbody>
        <% _.each( data_to_template.campaign_spending, function( d ){ %>
            <tr>
                 <td><%= d.recipient %></td>
                 <td><%= d.purpose %></td>
                 <td class="r"><%= d.display_date %></td>
                 <td class="r">
                    <% if (d.cash > 0) { %>
                        $<%= addCommas(d.cash.toFixed(0)) %>
                    <% }; %>
                    <% if (d.inkind > 0) { %>
                        $<%= addCommas(d.inkind.toFixed(0)) %>*
                    <% }; %>
                 </td>
            </tr>
        <% }); %>
        </tbody>
    </table>
    {% endif %}
    
</script>
{% endif %}

{% if loans %}
<!-- underscore template for loans table -->
<script type="text/html" class="loans_table_template">
    <table class="table table-condensed">
		<thead>
			<tr>
				<th>Lender</th>
				<th class="r">Loans</th>
				<th class="r">Borrowed</th>
                <th class="r">Repaid</th>
                <th class="r">Forgiven</th>
			</tr>
        </thead>
        <tbody>
    <% _.each(data_to_template.loan_data, function(d) { %>
        <tr class="totals">
            <td><%= d.name %></td>
            <td class="r"><%= d.borrowed.length %>&ensp;<i class="fa fa-caret-down text-muted click_to_expand" data-toggle="tooltip" title="Click for more details"></i></td>
            <td class="r">$<%= addCommas(sum(_.pluck(d.borrowed, "borrowed")).toFixed(0).replace(".00","")) %></td>
            <td class="r">$<%= addCommas(sum(_.pluck(d.repaid, "repaid")).toFixed(0).replace(".00","")) %></td>
            <td class="r">$<%= addCommas(sum(_.pluck(d.forgiven, "forgiven")).toFixed(0).replace(".00","")) %></td>
        </tr>
    <!-- here's the loop with the stuff to show/hide -->
        <% _.times(_.max([d.borrowed.length, d.repaid.length, d.forgiven.length]), function(z) { %>
        <tr class="toggle small">
            <td><%= d.name %></td>
            <td></td>
            <td class="r"><% if ( d.borrowed[z] ) { %>$<%= addCommas(d.borrowed[z].borrowed.toFixed(2).replace(".00","")) %> (<%= d.borrowed[z].display_date %>)<% }; %></td>
            <td class="r"><% if ( d.repaid[z] ) { %>$<%= addCommas(d.repaid[z].repaid.toFixed(2).replace(".00","")) %> (<%= d.repaid[z].display_date %>)<% }; %></td>
            <td class="r"><% if ( d.forgiven[z] ) { %>$<%= addCommas(d.forgiven[z].forgiven.toFixed(2).replace(".00","")) %> (<%= d.forgiven[z].display_date %>)<% }; %></td>
        </tr>
        <% }); %>
    <!-- // -->
        
    <% }); %>
    
        </tbody>
    </table>
    
    
    
</script>
{% endif %}

</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if gets or loans or gives or normal_expenditures or ind_expenditures %}
<script src="http://www.dataomaha.com/media/scripts/owh-utils.js"></script>
<script src="http://www.dataomaha.com/media/scripts/bootstrap-datepicker/bootstrap-datepicker.js"></script>

<script>

    // set colors for transaction types (backgrounds) and table charts (bars)
    {% if gives %}var givescolor = "red";{% endif %}
    {% if gets %} var getscolor = "blue";{% endif %}
    {% if loans %}var loanscolor = "green";{% endif %}
    {% if normal_expenditures or ind_expenditures %}var spendcolor = "orange";{% endif %}

    var APmonths = ['Jan.', 'Feb.', 'March', 'April', 'May', 'June', 'July', 'Aug.', 'Sept.', 'Oct.', 'Nov.', 'Dec.'];

    var dateDuder = function(datestring) {
        var d = datestring.split("/");
        return APmonths[Number(d[0])-1] + " " + d[1] + ", " + d[2];
    };

    var jankPluralize = function(num) {
        if (Number(num) === 1) {
            return "";
        } else {
            return "s";
        };
    }
    
    var sum = function(ls) {
        return _.reduce(ls, function(memo, num){ return memo + num; }, 0);
    };
    
    // set global template variable
    _.templateSettings.variable = "data_to_template";
    
    // instantiate datepickers
    $('.input-daterange input').each(function() {
        $(this).datepicker({
            clearBtn: true
        });
    });
    
    //build page data object
    var page_data = {};
    
    {% if gives %}page_data['gives'] = [{% for record in gives %}{"pk": "{{ record.pk }}", "display_date":"{{ record.donation_date|date:"N j, Y" }}", "donation_date":"{{ record.donation_date|date:"n/j/Y" }}", "inkind": {{ record.inkind }}, "cash":{{ record.cash }},  "recipient_id":"{{ record.recipient.nadcid }}", "recipient_name":"{% if record.recipient and record.recipient != "" %}{{ record.recipient.standard_name|safe|title }}{% else %}{{ record.notes }}{% endif %}"}{% if not forloop.last %},{% endif %}{% endfor %}];{% endif %}
    
    {% if gets %}page_data['gets'] = [{% for record in gets %}{% if record.pledge == 0 %}{"display_date":"{{ record.donation_date|date:"N j, Y" }}", "donation_date":"{{ record.donation_date|date:"n/j/Y" }}", "inkind": {{ record.inkind }}, "cash":{{ record.cash }},  "donor_id":"{{ record.donor.canonical }}", "donor":"{{ record.donor.standard_name|title|safe }}"}{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}];{% endif %}
    
    {% if normal_expenditures or ind_expenditures %}
    var expenditures = {};
    
    {% if normal_expenditures %}expenditures['campaign_expenditures'] = [{% for record in normal_expenditures %}{"display_date":"{{ record.exp_date|date:"N j, Y" }}", "exp_date":"{{ record.exp_date|date:"n/j/Y" }}",{% if record.in_kind and record.in_kind > 0 %} "inkind": {{ record.in_kind }},{% endif %}{% if record.amount and record.amount > 0 %} "cash":{{ record.amount }},{% endif %} "recipient":"{{ record.payee|safe|title }}", "purpose": "{% if record.exp_purpose %}{{ record.exp_purpose|title }}{% else %}Not listed{% endif %}"}{% if not forloop.last %}, {% endif %}{% endfor %}];{% endif %}
    
    {% if ind_expenditures %}expenditures['targeted_expenditures'] = [{% for exp in ind_expenditures %} { {% if exp.target_committee %}"target_committee_id": "{{exp.target_committee.pk}}", "target_committee_slug": "{{ exp.target_committee.standard_name|slugify }}", "target_committee_name": "{{ exp.target_committee.standard_name|title }}", {% endif %}{% if exp.target_candidate %}"target_candidate_id": "{{ exp.target_candidate.pk }}", "target_candidate_slug": "{{ exp.target_candidate.cand_name|slugify }}", "target_candidate_name": "{{ exp.target_candidate.cand_name }}", {% endif %} "payee": "{{ exp.payee|title }}", "stance": "{% if exp.stance == '0' %}Support{% elif exp.stance == '1' %}Oppose{% else %}Unspecified{% endif %}", "purpose":{% if exp.exp_purpose %}"{{ exp.exp_purpose|title }}"{% else %}"Not listed"{% endif %},"display_date": "{{ exp.exp_date|date:"N j, Y" }}","exp_date": "{{ exp.exp_date|date:"n/j/Y" }}", "amount": {{ exp.amount }}, "inkind": {{ exp.in_kind }} }{% if not forloop.last %},{% endif %}{% endfor %}];{% endif %}
    
    page_data['expenditures'] = expenditures;
    {% endif %}
    
    {% if loans %}page_data['loans'] = [{% for loan in loans %}{ {% if loan.loan_amount and loan.loan_amount > 0 %}"borrowed": {{ loan.loan_amount }}, {% endif %}{% if loan.loan_repaid and loan.loan_repaid > 0 %}"repaid": {{ loan.loan_repaid }}, {% endif %}{% if loan.loan_forgiven and loan.loan_forgiven > 0 %}"forgiven": {{ loan.loan_forgiven }}, {% endif %}"lender":"{{ loan.lender_name|safe|title }}", "display_date": "{{ loan.loan_date|date:"N j, Y" }}","loan_date": "{{ loan.loan_date|date:"n/j/Y" }}"}{% if not forloop.last %},{% endif %}{% endfor %}];{% endif %}
    
    //function to get start/end dates, if present in datepicker, and return an object
    var getDateRange = function() {
        var start_date_val = $('#startdate').val();
        var end_date_val = $('#enddate').val();
        if ( start_date_val && start_date_val != "") {
           var start_date = new Date(start_date_val);
        };        
        if ( end_date_val && end_date_val != "") {
           var end_date = new Date(end_date_val);
        };        
        if ( start_date || end_date ) {
            // if both dates are present, make sure the end date comes after the start date
            if (start_date && end_date && (end_date < start_date)) {
                alert("End date " + end_date_val + " comes before start date " + start_date_val);
                return false;
            };
            
            var daterange = {};
            
            if (start_date) {
                daterange["start"] = start_date;
            };
            if (end_date) {
                daterange["end"] = end_date;
            };
            return daterange;
        };
        return false;
    };
    
    //main function to update tables, charts, heds, summaries
    var updatePage = function(e) {
        $("#loading").show();
        
        $("#display_table").html("");
        
        // is the date range restricted?
        var daterange = getDateRange();
        
        //get filtered data, or not
        if (daterange) {
            if ( daterange.start && daterange.end ) {
            // is there a start and end date?
                {% if gives %}var gives_data_to_work_with = _.filter(page_data.gives, function(d) {
                    var x = new Date(d.donation_date);
                    return x.getTime() <= daterange.end.getTime() && x.getTime() >= daterange.start.getTime()
                });{% endif %}
                {% if gets %}var gets_data_to_work_with = _.filter(page_data.gets, function(d) {
                    var x = new Date(d.donation_date);
                    return x.getTime() <= daterange.end.getTime() && x.getTime() >= daterange.start.getTime()
                });{% endif %}
                {% if loans %}var loan_data_to_work_with = _.filter(page_data.loans, function(d) {
                    var x = new Date(d.loan_date);
                    return x.getTime() <= daterange.end.getTime() && x.getTime() >= daterange.start.getTime()
                });{% endif %}
                {% if ind_expenditures or normal_expenditures %}{% if ind_expenditures %}var targeted_spending_to_work_with = _.filter(page_data.expenditures.targeted_expenditures, function(d) {
                    var x = new Date(d.exp_date);
                    return x.getTime() <= daterange.end.getTime() && x.getTime() >= daterange.start.getTime()
                });{% endif %}
                {% if normal_expenditures %}var campaign_spending_to_work_with = _.filter(page_data.expenditures.campaign_expenditures, function(d) {
                    var x = new Date(d.exp_date);
                    return x.getTime() <= daterange.end.getTime() && x.getTime() >= daterange.start.getTime()
                });{% endif %}{% endif %}
            } else if ( daterange.start && !daterange.end ) {
            // is there a start date but no end date?                    
                {% if gives %}var gives_data_to_work_with = _.filter(page_data.gives, function(d) {
                    var x = new Date(d.donation_date);
                    return x.getTime() >= daterange.start.getTime()
                });{% endif %}
                {% if gets %}var gets_data_to_work_with = _.filter(page_data.gets, function(d) {
                    var x = new Date(d.donation_date);
                    return x.getTime() >= daterange.start.getTime()
                });{% endif %}
                {% if loans %}var loan_data_to_work_with = _.filter(page_data.loans, function(d) {
                        var x = new Date(d.loan_date);
                        return x.getTime() >= daterange.start.getTime()
                    });
                {% endif %}
                {% if ind_expenditures or normal_expenditures %}{% if ind_expenditures %}var targeted_spending_to_work_with = _.filter(page_data.expenditures.targeted_expenditures, function(d) {
                    var x = new Date(d.exp_date);
                    return x.getTime() >= daterange.start.getTime()
                });{% endif %}
                {% if normal_expenditures %}var campaign_spending_to_work_with = _.filter(page_data.expenditures.campaign_expenditures, function(d) {
                    var x = new Date(d.exp_date);
                    return x.getTime() >= daterange.start.getTime()
                });{% endif %}{% endif %}
            } else if ( daterange.end && !daterange.start ) {
            // is there an end date but no start date?                    
                {% if gives %}var gives_data_to_work_with = _.filter(page_data.gives, function(d) {
                    var x = new Date(d.donation_date);
                    return x.getTime() <= daterange.end.getTime()
                });{% endif %}
                {% if gets %}var gets_data_to_work_with = _.filter(page_data.gets, function(d) {
                    var x = new Date(d.donation_date);
                    return x.getTime() <= daterange.end.getTime()
                });{% endif %}
                {% if loans %}var loan_data_to_work_with = _.filter(page_data.loans, function(d) {
                    var x = new Date(d.loan_date);
                    return x.getTime() <= daterange.end.getTime()
                });{% endif %}
                {% if ind_expenditures or normal_expenditures %}{% if ind_expenditures %}var targeted_spending_to_work_with = _.filter(page_data.expenditures.targeted_expenditures, function(d) {
                    var x = new Date(d.exp_date);
                    return x.getTime() <= daterange.end.getTime()
                });{% endif %}
                {% if normal_expenditures %}var campaign_spending_to_work_with = _.filter(page_data.expenditures.campaign_expenditures, function(d) {
                    var x = new Date(d.exp_date);
                    return x.getTime() <= daterange.end.getTime()
                });{% endif %}{% endif %}
            };
            
            $('.filterwarning').show();
            
        } else {
            {% if gives %}var gives_data_to_work_with = page_data.gives;{% endif %}
            {% if gets %}var gets_data_to_work_with = page_data.gets;{% endif %}
            {% if loans %}var loan_data_to_work_with = page_data.loans;{% endif %}
            {% if ind_expenditures or normal_expenditures %}{% if ind_expenditures %}var targeted_spending_to_work_with = page_data.expenditures.targeted_expenditures;{% endif %}
            {% if normal_expenditures %}var campaign_spending_to_work_with = page_data.expenditures.campaign_expenditures;{% endif %}{% endif %}
        };
        
        {% if gives %}
        if ( e === "gives_button" || e === "gives" ) {
            $("#display_hed").html("Donations");
            
            // change bg color
            $("#wrapper").css("background", givescolor);
            
            if (gives_data_to_work_with.length > 0) {
                var gives_table_template = _.template($( "script.gives_table_template" ).html());
                
                var gives_data_to_page = {};
                gives_data_to_page['gives_color'] = givescolor;
                
                // group donations by ID
                var gives_out = _.chain(gives_data_to_work_with)
                    .groupBy("recipient_id")
                    .map(function(value, key) {
                        return {
                            id: key,
                            sum: sum(_.pluck(value, "cash").concat(_.pluck(value, "inkind"))),
                            name: _.pluck(value, "recipient_name")[0],
                            gives: value
                        }
                    })
                    .sortBy("sum").reverse()
                    .value();
                    
                    gives_data_to_page['gives_table_data'] = gives_out;
                    gives_data_to_page['gives_total_sum'] = sum(_.pluck(gives_out,"sum"));
                
                    // populate the underscore templates
                    $("#display_table").html(gives_table_template(gives_data_to_page));
                    
                    //bind click event to drop table row
                    $(".click_to_expand").bind("click", function(d) {
                        if ($(this).attr("data-original-title") === "Click for more details") {
                            $(this).attr("data-original-title", "Click to collapse")
                        } else {
                            $(this).attr("data-original-title", "Click for more details")
                        };
                        $(this).parent().parent().nextUntil("tr.totals").toggle();
                    });
            } else {
                $("#display_table").html("<p class='lead ital'>No donation records fall within that date range.</p>");
            };
        };
        {% endif %}
        
        {% if gets %}
        if ( e === "gets_button" || e === "gets" ) {
            $("#display_hed").html("Donations received");
            
            // change bg color
            $("#wrapper").css("background", getscolor);
            
            if (gets_data_to_work_with.length > 0) {
                var gets_table_template = _.template($( "script.gets_table_template" ).html());
                
                var gets_data_to_page = {};
                gets_data_to_page['gets_color'] = getscolor;
                
                // group donations by ID
                var gets_out = _.chain(gets_data_to_work_with)
                .groupBy("donor_id")
                .map(function(value, key) {
                    return {
                        id: key,
                        sum: sum(_.pluck(value, "cash").concat(_.pluck(value, "inkind"))),
                        name: _.pluck(value, "donor")[0],
                        gives: value
                    }
                })
                .sortBy("sum").reverse()
                .value();
                
                gets_data_to_page['gets_table_data'] = gets_out;
                gets_data_to_page['gets_total_sum'] = sum(_.pluck(gets_out,"sum"));
            
                // populate the underscore templates
                $("#display_table").html(gets_table_template(gets_data_to_page));
                
                //bind click event to drop table row
                $(".click_to_expand").bind("click", function(d) {
                    if ($(this).attr("data-original-title") === "Click for more details") {
                            $(this).attr("data-original-title", "Click to collapse")
                        } else {
                            $(this).attr("data-original-title", "Click for more details")
                        };
                    $(this).parent().parent().nextUntil("tr.totals").toggle();
                });
            } else {
                $("#display_table").html("<p class='lead ital'>No donation records fall within that date range.</p>");
            };
        };
        {% endif %}
        
        {% if loans %}
        if ( e === "loans_button" || e === "loans" ) {
            $("#display_hed").html("Loans");
            
            // change bg color
            $("#wrapper").css("background", loanscolor);
            
            var loan_data_to_page = {};
            loan_data_to_page['loans_color'] = loanscolor;
            
            if (loan_data_to_work_with.length > 0) {
                var loan_table_template = _.template($( "script.loans_table_template" ).html());
                
                var loans_out = _.chain(loan_data_to_work_with)
                .groupBy("lender")
                .map(function(value, key) {
                    return {
                        name: key,
                        borrowed: _.filter(value, function(g) { return _.has(g, "borrowed") }),
                        repaid: _.filter(value, function(g) { return _.has(g, "repaid") }),
                        forgiven: _.filter(value, function(g) { return _.has(g, "forgiven") })
                    }
                })
                .value();
                
                loan_data_to_page['loan_data'] = loans_out;

                $("#display_table").html(loan_table_template(loan_data_to_page));
                
                $(".click_to_expand").bind("click", function(d) {
                        if ($(this).attr("data-original-title") === "Click for more details") {
                            $(this).attr("data-original-title", "Click to collapse")
                        } else {
                            $(this).attr("data-original-title", "Click for more details")
                        };
                        $(this).parent().parent().nextUntil("tr.totals").toggle();
                });
                
            } else {
                $("#display_table").html("<p class='lead ital'>No lending records fall within that date range.</p>");
            };
        };
        {% endif %}
        
        {% if ind_expenditures or normal_expenditures %}
        if ( e === "spending_button" || e === "expenditures" ) {
            var exp_out = {};
            
            // change bg color etc.
            $("#display_hed").html("Expenditures");
            $("#wrapper").css("background", spendcolor);
            exp_out['spending_color'] = spendcolor;
            
            {% if ind_expenditures %}
            // group targeted spending by ID of targeted committee
            var targeted_spending_out = _.chain(targeted_spending_to_work_with)
                .groupBy("target_committee_id")
                .map(function(value, key) {
                    return {
                        id: key,
                        sum: sum(_.pluck(_.filter(value, function(d) { return _.has(d, "amount") }), "amount").concat(_.pluck(_.filter(value, function(d) { return _.has(d, "inkind") }), "inkind"))),
                        name: _.pluck(value, "target_committee_name")[0],
                        slug: _.pluck(value, "target_committee_slug")[0],
                        spending: value
                    }
                })
                .sortBy("sum").reverse()
                .value();
            
            exp_out['targeted_spending_data'] = targeted_spending_out;
            exp_out['targeted_spending_total'] = sum(_.pluck(targeted_spending_out,"sum"));
            
            {% endif %}
            {% if normal_expenditures %}exp_out['campaign_spending'] = campaign_spending_to_work_with;{% endif %}
            
            if ((exp_out.targeted_spending_data && exp_out.targeted_spending_data.length > 0) || (exp_out.campaign_spending && exp_out.campaign_spending.length > 0) ) {
                var spending_table_template = _.template($( "script.spending_table_template" ).html());
                $("#display_table").html(spending_table_template(exp_out));
                if (exp_out.targeted_spending_data && exp_out.targeted_spending_data.length > 0) {
                    //bind click event to drop table row
                    $(".click_to_expand").bind("click", function(d) {
                        if ($(this).attr("data-original-title") === "Click for more details") {
                                $(this).attr("data-original-title", "Click to collapse")
                            } else {
                                $(this).attr("data-original-title", "Click for more details")
                            };
                        $(this).parent().parent().nextUntil("tr.totals").toggle();
                    });
                };
            } else {
                $("#display_table").html("<p class='lead ital'>No expenditure records fall within that date range.</p>");
            };
        };
        {% endif %}    
    
        $('[data-toggle="tooltip"]').tooltip({"trigger": "hover"});
        $("#loading").hide();
    };
  
$(document).ready(function() {        
        // load share buttons
        var $tw = $("#tw");
        var $fb = $("#fb");
        
        var msg = "https://twitter.com/intent/tweet?text=" + encodeURIComponent("Explore campaign finance data for {% if name.standard_name %}{{ name.standard_name|title }}{% else %}{{ name.cand_name|title }}{% endif %} on @dataomaha's new search engine for political money: " + window.location);
        
        $tw.attr({
            'href': msg,
            'target': '_blank'
        });
        $fb.attr({
            'href':'http://www.facebook.com/sharer.php?u=' + encodeURIComponent(window.location),
            'target': '_blank'           
        });
        
        {% if gives %}
        //get total cash and inkind, feed to top-line summary hed
        var gives_cash_and_inkind = _.pluck(page_data.gives, "cash").concat(_.pluck(page_data.gives, "inkind"));
        
        if (sum(gives_cash_and_inkind) > 0) {
            $('#givestotal').html('<h3 class="bold" style="margin-bottom:0;">$' + addCommas(sum(gives_cash_and_inkind).toFixed(0).replace(".00","")) + '</h3><p class="small ital">Donated</p>');
        };
        {% endif %}
        
        {% if gets %}        
        //get total cash and inkind, feed to top-line summary hed
        var gets_cash_and_inkind = _.pluck(page_data.gets, "cash").concat(_.pluck(page_data.gets, "inkind"));
        
        if (sum(gets_cash_and_inkind) > 0) {
            $('#getstotal').html('<h3 class="bold" style="margin-bottom:0;">$' + addCommas(sum(gets_cash_and_inkind).toFixed(0).replace(".00","")) + '</h3><p class="small ital">Raised</p>');                
        };
        
        {% endif %}
        
        {% if loans %}
        //get total borrowed, feed to top-line summary hed
        var borrowed_total = sum(_.pluck(
            _.filter(page_data.loans, function(s) { return _.has(s, "borrowed") } )
            , "borrowed"));
        
        if (borrowed_total > 0) {
            $("#loantotal").html('<h3 class="bold" style="margin-bottom:0;">$' + addCommas(borrowed_total.toFixed(0)).replace(".00","") + '</h3><p class="small ital">Borrowed</p>');
        };
        {% endif %}
        
        {% if ind_expenditures or normal_expenditures %}
        {% if ind_expenditures %}
        // womp targeted spending into top-line summary
        var total_targeted_spending = sum(_.pluck(
            _.filter(page_data.expenditures.targeted_expenditures, function(z) { return _.has(z, "amount" )}), "amount")
                .concat(_.pluck(
            _.filter(page_data.expenditures.targeted_expenditures, function(z) { return _.has(z, "inkind" )}), "inkind")));
            
        if ( total_targeted_spending > 0 ) {
            $("#targeted_spending_total").html('<h3 class="bold" style="margin-bottom:0;">$' + addCommas(total_targeted_spending.toFixed(0)).replace(".00","") + '</h3><p class="small ital">Spending to support/oppose</p>');
        };
        {% endif %}

        {% if normal_expenditures %}        
        // womp campaign spending into top-line summary
        var total_campaign_spending = sum(_.pluck(
                _.filter(page_data.expenditures.campaign_expenditures, function(z) { return _.has(z, "cash" )}), "cash")
                    .concat(_.pluck(
                _.filter(page_data.expenditures.campaign_expenditures, function(z) { return _.has(z, "inkind" )}), "inkind")));
        
        
        if ( total_campaign_spending > 0 ) {
            $("#campaign_spending_total").html('<h3 class="bold" style="margin-bottom:0;">$' + addCommas(total_campaign_spending.toFixed(0)).replace(".00","") + '</h3><p class="small ital">Campaign spending</p>');
        };
        
        {% endif %}
        {% endif %}
    
    if (_.size(page_data) > 1) {
        var buttonstring = '<div class="col-sm-8"><h4><i class="fa fa-dot-circle-o"></i> Select type</h4><div class="btn-group btn-group-justified" role="group">{% if gets %}<a type="button" id="gets_button" class="btn btn-default topclicker gets  light">Raised</a>{% endif %}{% if gives %}<a type="button" id="gives_button" class="btn btn-default topclicker gives light">Donations</a>{% endif %}{% if ind_expenditures or normal_expenditures %}<a type="button" id="spending_button" class="btn btn-default topclicker expenditures light">Expenditures</a>{% endif %}{% if loans %}<a type="button" id="loans_button" class="btn btn-default topclicker loans light">Loans</a>{% endif %}</div></div>';
        
        $("#button_duder").html(buttonstring);
        
        $(".topclicker").bind("click", function(d) {
            $(".topclicker").attr("class", "btn btn-default topclicker");
            $(this).attr("class", "btn btn-primary topclicker");
            var id = this.id;
            updatePage(id);
        });
        
        // trigger click on first button
        $(".topclicker").eq(0).trigger("click");
    
        $("#date_filter_button").click(function() {        
            $('.topclicker').each(function() {
                if (/btn-primary/i.test(this.className)) {
                    updatePage(this.id);
                };                
            });
        });
        
        $(".removefilter").click(function() {
            $('#startdate').val("");
            $('#enddate').val("");
            $('.topclicker').each(function() {
                 if (/btn-primary/i.test(this.className)) {
                    updatePage(this.id);
                };                
            });
            $('.filterwarning').hide();
        });
    
    } else {
        var k = _.keys(page_data)[0];
        updatePage(k);        
        $("#date_filter_button").click(function() {
            updatePage(k);
        });
        
        $(".removefilter").click(function() {
            $('#startdate').val("");
            $('#enddate').val("");
            updatePage(k);
            $('.filterwarning').hide();
        });
    };
    
    $('a[href*=#]:not([href=#])').click(function() {
    if (location.pathname.replace(/^\//,'') === this.pathname.replace(/^\//,'') && location.hostname === this.hostname) {
      var target = $(this.hash);
      target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
      if (target.length) {
        $('html,body').animate({
          scrollTop: target.offset().top
        }, 1000);
        return false;
      }
    }
  });

});

</script>
{% endif %}
{% endblock %}