{% extends 'nadc/base.html' %}
{% load humanize %}
{% load staticfiles %}
{% load humanize %}

{% block title %}{% endblock %}

{% block morestyles %}
    <link href="{% static "nadc/entity.css" %}" rel="stylesheet">
{% endblock %}

{% block content %}

<div class="container">

<br><br><br>
<h1><b>{% if name.standard_name %}{{ name.standard_name }}{% else %}{{ name.cand_name }}{% endif %}</b></h1>
{% if name.city and name.state %}<h4>{{ name.city|title }}, {{ name.state }}</h4>{% endif %}
{% if name.dissolved_date %}<h4>(Committee dissolved in {{ name.dissolved_date|date:"o" }}</h4>{% endif %}
{% if name.employer or name.occupation or name.place_of_business %}<h4>{{ name.occupation|title }} at {{ name.employer|title }}, {{ name.place_of_business|title }}</h4>{% endif %}
{% if gets %}<h4><a href="http://www.nadc.nebraska.gov/ccdb/search.cgi?page=details&type=committee&IDNO={{ name.nadcid }}" target="_blank">Official NADC records</a></h4>{% endif %}


{% if gives %}
<h3 class="bold" style="margin-bottom:0;">${{ totalcashdonated.cash__sum|add:totalinkinddonated.inkind__sum|intcomma }}</h3>
<p class="small ital">CASH AND IN-KIND DONATIONS</p>
{% endif %}
{% if gets %}
<h3 class="bold" style="margin-bottom:0;">${{ totalcashreceived.cash__sum|add:totalinkindreceived.inkind__sum|intcomma }}</h3>
<p class="small ital">RAISED</p>
{% endif %}
{% if normal_expenditures %}
<h3 class="bold" style="margin-bottom:0;">${{ normal_spent.amount__sum|intcomma }}</h3>
<p class="small ital">SPENT</p>
{% endif %}
{% if ind_expenditures %}
<h3 class="bold" style="margin-bottom:0;">${{ ind_spent.amount__sum|intcomma }}</h3>
<p class="small ital">SPENT DIRECTLY IN OTHER POLITICAL RACES</p>
{% endif %}
{% if loans %}
<h3 class="bold" style="margin-bottom:0;">${{ totalborrowed.loan_amount__sum|intcomma }}</h3>
<p class="small ital">BORROWED</p>
{% endif %}

{% comment %}
{% if comm_candidates %}
    <h4>Candidate{{ comm_candidates|pluralize }} supported</h4>
    <ul>
    {% for can in comm_candidates %}
    {% if can.stance == "0" %}
        <li>{{ can.cand_name|title }} ({{ can.office_desc|title }} {{ can.office_title|title }})</li>
    {% endif %}
    {% endfor %}
    </ul>
    {% if comm_candidates.count > 1 %}
    <h4>Candidate{{ comm_candidates|pluralize }} opposed</h4>
    <ul>
    {% for can in comm_candidates %}
    {% if can.stance == "1" %}
        <li>{{ can.cand_name|title }} ({{ can.office_desc|title }} {{ can.office_title|title }})</li>
    {% endif %}
    {% endfor %}
    </ul>
    {% endif %}

{% endif %}
{% endcomment %}

{% if person_candidates %}
    <h4>{% for can in person_candidates %}{% if forloop.first %}{{ can.cand_name|title }}{% endif %}{% endfor %} ran for office {{ person_candidates.count|apnumber }} time{{ person_candidates.count|pluralize }}.</h4>
    {% for can in person_candidates %}
        <li><a href="/campaign-finance/candidate/{{ can.cand_id }}">{{ can.cand_name|title }} ({{ can.office_desc|title }} {{ can.office_title|title }})</a></li>
    {% endfor %}
{% endif %}

<p>{{ name.standard_name|title }} {% if gives %}gave {{ gives.count|apnumber|intcomma }} donation{{ gives.count|pluralize }}{% endif %}{% if not gets %} between {{ first }} and {{ mostrecent }}.{% else %} {% if gives and gets %}and{% endif %} received {{ gets.count|apnumber|intcomma }} contribution{{ gets.count|pluralize }} between {{ first }} and {{ mostrecent }}. {% endif %}{% if comm_candidates %}It backed {% for candidate in comm_candidates %}{% if candidate.stance = "0" %}<a href="/campaign-finance/{{ candidate.cand_id }}/{{ candidate.cand_name|slugify }}">{{ candidate.cand_name|title }}</a> for {{ candidate.office_desc|title }} {{ candidate.office_title|title }}{% if not forloop.last %}{% if comm_candidates.count > 2 %}{% if not forloop.last %}, {% else %} and {% endif %} {% else %} and {% endif %}{% endif %}{% endif %}{% endfor %}{% endif %}</p>



<hr><hr>


CLICK DUDER LINKS HERE:

{% if gets %}
Raised (active)
{% endif %}

{% if gives %}
Donated
{% endif %}

{% if ind_expenditures or normal_expenditures %}
Spent
{% endif %}

{% if loans %}
Loans
{% endif %}

<div id="display_hed"></div>
<div id="display_graphics"></div>
<div id="display_table"></div>





{% if gets %}
	<h2>GETS</h2>

    {% if groupedgets.count > 5 %}
	<h3>Top donors</h3>
		
    
    <div id="getspiechart" style="width: 900px; height: 500px;"></div>
    {% endif %}
	
	<table class="table table-condensed">
		<thead>
			<tr>
				<th>Donor</th>
				<th class="r">Amount</th>
			</tr>
		</thead>
		<tbody>

		{% for donation in groupedgets %}
			<tr>
				<td><a href="/campaign-finance/{{ donation.donor__canonical }}/{{ donation.donor__standard_name|slugify }}">{{ donation.donor__standard_name|title }}</a></td>
				<td class="r">${{ donation.total|intcomma }}</td>
			</tr>
		{% endfor %}
		
		</tbody>
	</table>

{% endif %}


{% if gives %}
	<h2>GIVES</h2>
	
	<h3>Top committees supported</h3>
    
    {% if groupedgives.count > 5 %}
    <div id="gives_chart_div"></div>
    {% endif %}
    
	<div id="timeline" style="width:100%;height:300px"></div>

    <table class="table table-condensed">
		<tbody>
		{% for gift in groupedgives %}
			<tr>
				<td><a href="/campaign-finance/{{ gift.recipient__nadcid }}/{{ gift.recipient__name|slugify }}">{{ gift.recipient__name|title }}</a></td>
				<td class="r">${{ gift.total|intcomma }}</td>
			<tr>
		{% endfor %}
		</tbody>
	</table>

	
{% endif %}

{% if normal_expenditures %}

	<h2>EXPENDITURES</h2>
	<table class="table table-condensed">
		<thead>
			<th>Paid to</th>
			<th>For</th>
			<th class="r">Date</th>
			<th class="r">Amount</th>
		</thead>
		<tbody>
		
		{% for exp in normal_expenditures %}
			<tr>
				<td>{{ exp.payee|title }}</td>
				<td>{% if exp.exp_purpose %}{{ exp.exp_purpose|title }}{% else %}Not reported{% endif %}</td>
				<td class="r">{{ exp.exp_date }}</td>
				<td class="r">{% if exp.amount > 0 %}${{ exp.amount|intcomma }}{% else %}${{ exp.in_kind|intcomma }} (In-kind){% endif %}</td>
			</tr>
		{% endfor %}
		</tbody>
	</table>
{% endif %}

{% if ind_expenditures %}

	<h2>POLITICAL SPENDING</h2>
    <h4>Spending to support candidates or causes</h4>
	<table class="table table-condensed">
		<thead>
            <th>Supporting</th>
			<th>Paid to</th>
			<th>For</th>
			<th class="r">Date</th>
			<th class="r">Amount</th>
		</thead>
		<tbody>
		{% for exp in ind_expenditures %}
        {% if exp.stance == "0" %}
			<tr>
                <td>{% if exp.target_committee %}<a href="/campaign-finance/{{ exp.target_committee.pk }}/{{ exp.target_committee.standard_name|slugify }}">{{ exp.target_committee.standard_name|title }}</a>{% endif %}{% if exp.target_candidate %}<a href="/campaign-finance/{{ exp.target_candidate.pk }}/{{ exp.target_candidate.cand_name|slugify }}">{{ exp.target_candidate.cand_name }}</a>{% endif %}</td>
				<td>{{ exp.payee|title }}</td>
				<td>{% if exp.exp_purpose %}{{ exp.exp_purpose|title }}{% else %}Not reported{% endif %}</td>
				<td class="r">{{ exp.exp_date }}</td>
				<td class="r">{% if exp.amount > 0 %}${{ exp.amount|intcomma }}{% else %}${{ exp.in_kind|intcomma }} (In-kind){% endif %}</td>
			</tr>
        {% endif %}
        {% endfor %}
		</tbody>
	</table>
    
    <h4>Spending to attack candidates or causes</h4>
	<table class="table table-condensed">
		<thead>
            <th>Opposing</th>
			<th>Paid to</th>
			<th>For</th>
			<th class="r">Date</th>
			<th class="r">Amount</th>
		</thead>
		<tbody>
		{% for exp in ind_expenditures %}
        {% if exp.stance == "1" %}
			<tr>
                <td>{% if exp.target_committee %}{{ exp.target_committee.standard_name|title }}{% endif %}{% if exp.target_candidate %}{{ exp.target_candidate.cand_name }}{% endif %}</td>
				<td>{{ exp.payee|title }}</td>
				<td>{% if exp.exp_purpose %}{{ exp.exp_purpose|title }}{% else %}Not reported{% endif %}</td>
				<td class="r">{{ exp.exp_date }}</td>
				<td class="r">{% if exp.amount > 0 %}${{ exp.amount|intcomma }}{% else %}${{ exp.in_kind|intcomma }} (In-kind){% endif %}</td>
			</tr>
        {% endif %}
        {% endfor %}
		</tbody>
	</table>
    
    <h4>Spending that wasn't identified as being in opposition or support</h4>
	<table class="table table-condensed">
		<thead>
            <th>Targeting</th>
			<th>Paid to</th>
			<th>For</th>
			<th class="r">Date</th>
			<th class="r">Amount</th>
		</thead>
		<tbody>
		{% for exp in ind_expenditures %}
        {% if exp.stance == "" %}
			<tr>
                <td>{% if exp.target_committee %}{{ exp.target_committee.standard_name|title }}{% endif %}{% if exp.target_candidate %}{{ exp.target_candidate.cand_name }}{% endif %}</td>
				<td>{{ exp.payee|title }}</td>
				<td>{% if exp.exp_purpose %}{{ exp.exp_purpose|title }}{% else %}Not reported{% endif %}</td>
				<td class="r">{{ exp.exp_date }}</td>
				<td class="r">{% if exp.amount > 0 %}${{ exp.amount|intcomma }}{% else %}${{ exp.in_kind|intcomma }} (In-kind){% endif %}</td>
			</tr>
        {% endif %}
        {% endfor %}
		</tbody>
	</table>
    
{% endif %}

{% if loans %}
	<h2>LOANS</h2>
	
	<h3>Loans taken</h3>
	<table class="table table-condensed">
		<thead>
			<tr>
				<th>Lender</th>
				<th>Date borrowed</th>
				<th>Amount</th>
			</tr>
		</thead>
		<tbody>
			{% for loan in loans %}
			{% if loan.loan_amount > 0 %}
			<tr>
				<td>{{ loan.lender_name }}</td>
				<td>{{ loan.loan_date }}</td>
				<td>${{ loan.loan_amount|intcomma  }}</td>
			</tr>
			{% endif %}
			{% endfor %}
		</tbody>
	</table>
	
    {% if loan.loan_repaid > 0 %}
	<h3>Loans repaid</h3>
	<table class="table table-condensed">
		<thead>
			<tr>
				<th>Lender</th>
				<th>Date repaid</th>
				<th>Amount</th>
			</tr>
		</thead>
		<tbody>
			{% for loan in loans %}
			<tr>
				<td>{{ loan.lender_name }}</td>
				<td>{{ loan.loan_date }}</td>
				<td>${{ loan.loan_repaid|intcomma  }}</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
    {% endif %}

    {% if loan.loan_forgiven > 0 %}
	<h3>Loans forgiven</h3>
	<table class="table table-condensed">
		<thead>
			<tr>
				<th>Lender</th>
				<th>Date forgiven</th>
				<th>Amount</th>
			</tr>
		</thead>
		<tbody>
			{% for loan in loans %}
			<tr>
				<td>{{ loan.lender_name }}</td>
				<td>{{ loan.loan_date }}</td>
				<td>${{ loan.loan_forgiven|intcomma  }}</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
    {% endif %}
	
{% endif %}

<script type="text/html" class="gives_table_template">
    
    <hr>
    <p class="pull-right">Showing <%= data_to_template.table_start %>-<%= data_to_template.table_end %> of <%= data_to_template.give_data.length %> records.</p>

    <table class="table table-condensed">
        <thead>
            <tr>
                <th>Recipient (donations)</th>
                <th>Total (click for details)</th>
            </tr>
        </thead>
        <tbody>
        <% _.each( data_to_template.give_data, function( d, i ){ %>
            <% if (i < data_to_template.table_end) { %>
            <tr>
                 <td><a href="/campaign-finance/<%= d.id %>"><%= d.name %></a> (<%= d.gives.length %>)</td>
                 <td><a class="click_to_expand" href="javascript:void(0)">$<%= addCommas(d.sum.toFixed(2).replace(".00","")) %></a></td>
            </tr>
            <% }; %>
        <% }); %>
        </tbody>
    </table>
</script>

{% if groupedgives.count > 5 %}
<script type="text/html" class="gives_chart_template">

<h3 class="bold">Top committees supported</h3>
<% _.each( data_to_template.topfive, function( d ){ %>
    <div class="row" style="margin-bottom:10px;">
        <div class="col-md-5" style="margin-top:6px;"><a class="bold" href="/campaign-finance/<%= d.id %>/<%= slugify(d.name) %>"><%= d.name %></a> ($<%= addCommas(Math.round(d.sum)) %>)</div>
        <div class="col-md-7">
            <div class="row" id="topper" style='margin:0px; background: -webkit-gradient(linear, left top,right top, color-stop(<%= getPct(d.sum, data_to_template.overall_tot) %>%,#4cae4c), color-stop(<%= getPct(d.sum, data_to_template.overall_tot) %>%,#eee)); background: -moz-linear-gradient(left center, #4cae4c <%= getPct(d.sum, data_to_template.overall_tot) %>%, #eee <%= getPct(d.sum, data_to_template.overall_tot) %>%); background: -o-linear-gradient(left,#4cae4c <%= getPct(d.sum, data_to_template.overall_tot) %>%, #eee <%= getPct(d.sum, data_to_template.overall_tot) %>%); linear-gradient(to right,#4cae4c <%= getPct(d.sum, data_to_template.overall_tot) %>%, #eee <%= getPct(d.sum, data_to_template.overall_tot) %>%)'>
                <div class="pull-right" style="text-align:right;">
                    <p class="bold" style="margin:5px 5px auto auto;"><%= getPct(d.sum, data_to_template.overall_tot).toFixed(2) %>%</p>
                </div>
            </div>
        </div>
    </div>
<% }); %>
<hr>
    <div class="row" style="margin-bottom:10px;">
        <div class="col-md-5" style="margin-top:6px;"><%= data_to_template.rest.num %> other recipients ($<%= addCommas(Math.round(data_to_template.rest.tot)) %>)</div>
        <div class="col-md-7">
            <div class="row" id="topper" style='margin:0px; background: -webkit-gradient(linear, left top,right top, color-stop(<%= getPct(data_to_template.rest.tot, data_to_template.overall_tot) %>%,#4cae4c), color-stop(<%= getPct(data_to_template.rest.tot, data_to_template.overall_tot) %>%,#eee)); background: -moz-linear-gradient(left center, #4cae4c <%= getPct(data_to_template.rest.tot, data_to_template.overall_tot) %>%, #eee <%= getPct(data_to_template.rest.tot, data_to_template.overall_tot) %>%); background: -o-linear-gradient(left,#4cae4c <%= getPct(data_to_template.rest.tot, data_to_template.overall_tot) %>%, #eee <%= getPct(data_to_template.rest.tot, data_to_template.overall_tot) %>%); linear-gradient(to right,#4cae4c <%= getPct(data_to_template.rest.tot, data_to_template.overall_tot) %>%, #eee <%= getPct(data_to_template.rest.tot, data_to_template.overall_tot) %>%)'>
                <div class="pull-right" style="text-align:right;">
                    <p class="bold" style="margin:5px 5px auto auto;"><%= getPct(data_to_template.rest.tot, data_to_template.overall_tot).toFixed(2) %>%</p>
                </div>
            </div>
        </div>
    </div>
</script>
{% endif %}
</div>
{% endblock %}



{% block scripts %}
<script src="http://www.dataomaha.com/media/scripts/owh-utils.js"></script>
<script>
    
    // set template variable
    _.templateSettings.variable = "data_to_template";

    var sum = function(ls) {
        return _.reduce(ls, function(memo, num){ return memo + num; }, 0);
    };
    
    {% if gives %}
    // cash and in-kind donations
    var gives = [{% for record in gives %}{"donation_date":"{{ record.donation_date|date:"o-m-d" }}", "inkind": {{ record.inkind }}, "cash":{{ record.cash }},  "recipient_id":"{{ record.recipient.nadcid }}", "recipient_name":"{{ record.recipient.standard_name }}"}{% if not forloop.last %},{% endif %}{% endfor %}];
    
    var cash_and_inkind = _.pluck(gives, "cash").concat(_.pluck(gives, "inkind"));
    
    var gives_out = _.chain(gives)
        .groupBy("recipient_id")
        .map(function(value, key) {
            return {
                id: key,
                sum: sum(_.pluck(value, "cash").concat(_.pluck(value, "inkind"))),
                name: _.pluck(value, "recipient_name")[0],
                gives: value
            }
        })
        .sortBy("sum").reverse()
        .value();

    var make_gives_table = function(start, end) {
        var gives_data_to_template = {
            give_data: gives_out,
            table_start: start,
            table_end: end
        };
        // pass data to gives_table template
        var gives_table_template = _.template($( "script.gives_table_template" ).html());
        console.log(gives_data_to_template);
        $("#display_table").html(gives_table_template(gives_data_to_template));
    };
    
    make_gives_table(0, 25);
        
    {% if groupedgives.count > 5 %}
    var top5 = _.first(gives_out, 5);
    var restnum = gives_out.length - 5;
    var ot = sum(cash_and_inkind);
    var rest_tot = sum(cash_and_inkind) - sum(_.pluck(top5, "sum"));
    
    var gives_for_chart = {        
        overall_tot: ot,
        topfive: top5,
        rest: {
                num: restnum,
                tot: rest_tot
        }
    };

    // pass to template
    var template = _.template($( "script.gives_chart_template" ).html());
    $('#display_graphics').html(template(gives_for_chart));
    $("#display_hed").html("<h2 class='bold'>Donations</h2>")
    
    //bind click event to drop table
    $(".click_to_expand").bind("click", function(d) {
        $(this).parent().parent().next().show();
    });
    
    {% endif %}{# end if groupedgives.count > 5 #}
    {% endif %}{# end if gives #}
      
    {% if gets %}
    var gets = [{% for record in gets %}{"donation_date":"{{ record.donation_date|date:"m-d-o" }}", "inkind": {{ record.inkind }}, "cash":{{ record.cash }},  "donor_id":"{{ record.donor.nadcid }}", "donor":"{{ record.donor.standard_name }}"}{% if not forloop.last %},{% endif %}{% endfor %}];
      
      
      google.load("visualization", "1", {packages:["corechart"]});
      google.setOnLoadCallback(drawChart);
      function drawChart() {
        var data = google.visualization.arrayToDataTable([
          ['Donor', 'Dollars'],
          {% for donor in topgets %}
          ['{{ donor.donor__standard_name }}', {{ donor.total }}]{% if othergetstotal > 0 %},{% endif %}
          {% endfor %}
          {% if othergetstotal > 0 %}
          ['{{ groupedgets.count|add:-5 }} other donors', {{ othergetstotal }}]
          {% endif %}
        ]);

        var options = {
          title: 'Top donors'
        };

        var chart = new google.visualization.PieChart(document.getElementById('getspiechart'));

        chart.draw(data, options);
      };
      {% endif %}

      
/*
var timelinegives = [
{% for row in allgives %}
    [{{ forloop.counter }}, {{ row.total }}]{% if not forloop.last %},{% endif %}
{% endfor %}
];
var dataset = [{ data: timelinegives, color: "#5482FF" }];
var ticks = [ {% for row in allgives %}
    [{{ forloop.counter }}, "{{ row.donation_date }}"]{% if not forloop.last %},{% endif %}
    {% endfor %}];
    
var options = {
xaxis: {
  ticks: ticks
},
series: {
    bars: {
        show: true
    }
},
bars: {
    align: "center",
    barWidth: 0.5
}}

 $(document).ready(function () {
            $.plot($("#timeline"), dataset, options);

        });
*/
</script>
{% endblock %}


